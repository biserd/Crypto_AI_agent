{% extends "base.html" %}

{% block content %}
<style>
.crypto-header {
    padding: 1rem;
    background: linear-gradient(135deg, #2a2a72 0%, #009ffd 100%);
    color: white;
    margin-bottom: 1rem;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.price-display {
    font-size: 2rem;
    font-weight: bold;
    margin-right: 1rem;
}

.price-change {
    font-size: 1rem;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    display: inline-block;
}

.price-up {
    background: rgba(40, 167, 69, 0.2);
    color: #28a745;
}

.price-down {
    background: rgba(220, 53, 69, 0.2);
    color: #dc3545;
}

.recommendation-indicator {
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
    margin: 1rem 0;
    font-weight: bold;
    text-transform: uppercase;
}

.recommendation-buy {
    background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
    color: white;
}

.recommendation-sell {
    background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
    color: white;
}

.recommendation-hold {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: #1f2937;
}

.chart-container {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    height: 400px;
    position: relative;
}

.chart-wrapper {
    position: relative;
    height: 100%;
    width: 100%;
}

.timeframe-selector {
    margin-bottom: 1rem;
    display: flex;
    gap: 0.5rem;
}

.timeframe-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
}

.timeframe-btn.active {
    background: #2196F3;
    color: white;
    border-color: #2196F3;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.indicator-toggle {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.indicator-toggle label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.loading-overlay.active {
    display: flex;
}
</style>

{% set crypto_names = {
    'BTC': 'Bitcoin',
    'ETH': 'Ethereum', 
    'BNB': 'Binance Coin',
    'ADA': 'Cardano',
    'SOL': 'Solana',
    'XRP': 'Ripple',
    'DOGE': 'Dogecoin',
    'MATIC': 'Polygon',
    'AVAX': 'Avalanche'
} %}

<div class="crypto-header">
    <h1>{{ crypto_names[crypto.symbol] }} ({{ crypto.symbol }})</h1>
    <div class="price-display">${{ "%.2f"|format(crypto.price_usd) }}</div>
    <div class="price-change {% if crypto.percent_change_24h > 0 %}price-up{% else %}price-down{% endif %}">
        {{ "%.1f"|format(crypto.percent_change_24h) }}% (24h)
    </div>
</div>

<div class="chart-container">
    <div class="chart-header">
        <div class="timeframe-selector">
            <button class="timeframe-btn" data-timeframe="24h">24H</button>
            <button class="timeframe-btn" data-timeframe="7d">7D</button>
            <button class="timeframe-btn active" data-timeframe="30d">30D</button>
        </div>
        <div class="indicator-toggle">
            <label>
                <input type="checkbox" id="showSMA" checked>
                <span>SMA (7)</span>
            </label>
            <label>
                <input type="checkbox" id="showVolume" checked>
                <span>Volume</span>
            </label>
        </div>
    </div>
    <div class="chart-wrapper">
        <canvas id="priceChart"></canvas>
        <div class="loading-overlay">
            <div>Loading chart data...</div>
        </div>
    </div>
</div>

<!-- News Sentiment Analysis and Trading Signal -->
<div class="container-fluid px-4 mb-4">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">News Sentiment Analysis</h5>
                    <div class="sentiment-stats">
                        <div class="d-flex justify-content-between mb-3">
                            <div>
                                <h6>Positive Articles</h6>
                                <span class="badge bg-success">{{ news_impact.positive }}</span>
                            </div>
                            <div>
                                <h6>Neutral Articles</h6>
                                <span class="badge bg-warning">{{ news_impact.neutral }}</span>
                            </div>
                            <div>
                                <h6>Negative Articles</h6>
                                <span class="badge bg-danger">{{ news_impact.negative }}</span>
                            </div>
                        </div>
                        <div class="progress mb-3" style="height: 20px;">
                            {% set positive_percent = (news_impact.positive / news_impact.total_articles * 100) if news_impact.total_articles > 0 else 0 %}
                            {% set neutral_percent = (news_impact.neutral / news_impact.total_articles * 100) if news_impact.total_articles > 0 else 0 %}
                            {% set negative_percent = (news_impact.negative / news_impact.total_articles * 100) if news_impact.total_articles > 0 else 0 %}

                            <div class="progress-bar bg-success" style="width: {{ positive_percent }}%" 
                                 title="Positive: {{ "%.1f"|format(positive_percent) }}%"></div>
                            <div class="progress-bar bg-warning" style="width: {{ neutral_percent }}%"
                                 title="Neutral: {{ "%.1f"|format(neutral_percent) }}%"></div>
                            <div class="progress-bar bg-danger" style="width: {{ negative_percent }}%"
                                 title="Negative: {{ "%.1f"|format(negative_percent) }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <!-- Trading Recommendation -->
            <div class="recommendation-indicator recommendation-{{ recommendation }}">
                Trading Signal: {{ recommendation|upper }}
            </div>
        </div>
    </div>
</div>

<div class="container-fluid px-4">
    <!-- News Section -->
    <div class="row">
        <div class="col-12">
            <h3>Latest {{ crypto.symbol }} News</h3>
            {% for article in news %}
            <div class="card mb-3 news-card">
                <div class="card-body">
                    <h5 class="card-title">{{ article.title }}</h5>
                    <h6 class="card-subtitle mb-2 text-muted">
                        {{ article.source_name }} - {{ article.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                    </h6>
                    <p class="card-text">{{ article.summary }}</p>
                    {% if article.sentiment_label %}
                    <div class="d-flex align-items-center">
                        <span class="sentiment-indicator sentiment-{{ article.sentiment_label|lower }}">
                            {{ article.sentiment_label|title }}
                            {% if article.sentiment_score %}
                            <span class="sentiment-score">{{ "%.2f"|format(article.sentiment_score) }}</span>
                            {% endif %}
                        </span>
                        <a href="{{ article.source_url }}" class="btn btn-primary btn-sm ms-auto" target="_blank">Read More</a>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Load Chart.js and related libraries -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>

<script>
let priceChart = null;
const loadingOverlay = document.querySelector('.loading-overlay');

// Debug logging helper
function logDebug(message, data) {
    console.log(`[Chart Debug] ${message}:`, data);
}

function formatValue(value) {
    if (value >= 1e9) {
        return (value / 1e9).toFixed(2) + 'B';
    } else if (value >= 1e6) {
        return (value / 1e6).toFixed(2) + 'M';
    } else if (value >= 1e3) {
        return (value / 1e3).toFixed(2) + 'K';
    }
    return value.toFixed(2);
}

async function updateChart(timeframe = '30d') {
    try {
        logDebug('Starting chart update for timeframe', timeframe);

        const apiUrl = `/api/price-history/{{ crypto.symbol }}?timeframe=${timeframe}`;
        logDebug('Fetching from URL', apiUrl);

        const response = await fetch(apiUrl);
        logDebug('API Response', {
            status: response.status,
            ok: response.ok,
            statusText: response.statusText
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }

        const data = await response.json();
        logDebug('Received data', data);

        if (!data || !data.prices || data.prices.length === 0) {
            throw new Error('No price data available');
        }

        const chartCanvas = document.getElementById('priceChart');
        if (!chartCanvas) {
            throw new Error('Price chart canvas element not found');
        }
        logDebug('Found chart canvas element', chartCanvas);

        if (priceChart) {
            logDebug('Destroying existing chart instance');
            priceChart.destroy();
        }

        const showSMA = document.getElementById('showSMA')?.checked ?? true;
        const showVolume = document.getElementById('showVolume')?.checked ?? true;

        const datasets = [];

        // Add price dataset
        datasets.push({
            label: '{{ crypto.symbol }} Price (USD)',
            data: data.prices.map(p => ({
                x: p[0],
                y: p[1]
            })),
            borderColor: '#2196F3',
            backgroundColor: 'rgba(33, 150, 243, 0.1)',
            fill: true,
            yAxisID: 'y',
            tension: 0.1
        });

        // Add SMA dataset if enabled
        if (showSMA && data.sma && data.sma.length > 0) {
            datasets.push({
                label: 'SMA (7)',
                data: data.sma.map(p => ({
                    x: p.timestamp,
                    y: p.value
                })),
                borderColor: '#FF9800',
                borderWidth: 2,
                pointRadius: 0,
                fill: false,
                yAxisID: 'y'
            });
        }

        // Add volume dataset if enabled
        if (showVolume && data.volumes && data.volumes.length > 0) {
            datasets.push({
                label: 'Volume',
                data: data.volumes.map(v => ({
                    x: v[0],
                    y: v[1]
                })),
                type: 'bar',
                backgroundColor: 'rgba(156, 39, 176, 0.2)',
                borderColor: 'rgba(156, 39, 176, 0.8)',
                yAxisID: 'y1'
            });
        }

        logDebug('Creating new chart with datasets', datasets);

        priceChart = new Chart(chartCanvas, {
            type: 'line',
            data: { datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                animation: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: timeframe === '24h' ? 'hour' : 'day',
                            displayFormats: {
                                hour: 'MMM D, HH:mm',
                                day: 'MMM D'
                            }
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Price (USD)'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: showVolume,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false
                        },
                        title: {
                            display: true,
                            text: 'Volume (USD)'
                        },
                        ticks: {
                            callback: function(value) {
                                return formatValue(value);
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.datasetIndex === 2) { // Volume dataset
                                    label += '$' + formatValue(context.parsed.y);
                                } else {
                                    label += '$' + context.parsed.y.toFixed(2);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });

        logDebug('Chart created successfully');

    } catch (error) {
        console.error('Error updating chart:', error);
    } finally {
        if (loadingOverlay) {
            loadingOverlay.classList.remove('active');
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    logDebug('DOM loaded, initializing chart');
    updateChart('30d');

    // Set up event listeners
    document.querySelectorAll('.timeframe-btn').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.timeframe-btn').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            updateChart(this.dataset.timeframe);
        });
    });

    // Set up indicator toggles
    const smaToggle = document.getElementById('showSMA');
    const volumeToggle = document.getElementById('showVolume');

    if (smaToggle) {
        smaToggle.addEventListener('change', () => {
            updateChart(document.querySelector('.timeframe-btn.active').dataset.timeframe);
        });
    }

    if (volumeToggle) {
        volumeToggle.addEventListener('change', () => {
            updateChart(document.querySelector('.timeframe-btn.active').dataset.timeframe);
        });
    }
});
</script>

{% endblock %}